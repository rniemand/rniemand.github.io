<!doctype html>
<html lang="en" class="h-100" data-bs-theme="dark">
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<title>Ceiling Fan Remote Hacking</title>
		<meta name="description" content="Coding and more">
		
		<link rel="stylesheet" href="//cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/css/bootstrap.min.css">
		<link rel="stylesheet" href="//cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.min.css">
		<meta name="generator" content="Eleventy v3.1.1">
		
		
		<style>@import url('https://fonts.googleapis.com/css2?family=Open+Sans:ital,wght@0,300..800;1,300..800&display=swap');

body {
	/* font-size: 1rem; */
	font-family: "Open Sans", sans-serif;
	font-optical-sizing: auto;
}

div.main-content {
	margin-top: 4rem;
	font-size: 1.2rem;
}

.blog-list a {
	text-decoration: none;
}

.post-meta .post-date time {
	color: #52a0d7;
}

div.main-content h1 {
	color: #c3e6ff;
	margin-bottom: 1rem;
}

div.main-content h2 {
	color: #ffd97f;
	margin-bottom: 1rem;
}

div.main-content h3 {
	color: #f0ff7f;
	margin-bottom: 1rem;
}

div.main-content pre {
	font-size: 1.1rem;
	background-color: #31363b;
	border: 1px solid #3f4851;
	padding: 0.5rem;
	margin-bottom: 1rem;
}

div.main-content picture img {
	border: 1px solid #454d55;
	max-width: 100%;
	height: auto;
	border-radius: 0.5rem;
	margin-bottom: 1rem;
	box-shadow: 5px 5px 10px 0px #2b3137;
}

div.main-content div.prev-next {
	background-color: #293037;
	border-radius: 0.5rem;
	padding: 0.5rem;
}

div.main-content table {
	border: 1px solid #363c43;
}

div.main-content .list-group-item:hover {
	background-color: #2b3137;
}
/**
 * okaidia theme for JavaScript, CSS and HTML
 * Loosely based on Monokai textmate theme by http://www.monokai.nl/
 * @author ocodia
 */

code[class*="language-"],
pre[class*="language-"] {
	color: #f8f8f2;
	background: none;
	text-shadow: 0 1px rgba(0, 0, 0, 0.3);
	font-family: Consolas, Monaco, 'Andale Mono', 'Ubuntu Mono', monospace;
	font-size: 1em;
	text-align: left;
	white-space: pre;
	word-spacing: normal;
	word-break: normal;
	word-wrap: normal;
	line-height: 1.5;

	-moz-tab-size: 4;
	-o-tab-size: 4;
	tab-size: 4;

	-webkit-hyphens: none;
	-moz-hyphens: none;
	-ms-hyphens: none;
	hyphens: none;
}

/* Code blocks */
pre[class*="language-"] {
	padding: 1em;
	margin: .5em 0;
	overflow: auto;
	border-radius: 0.3em;
}

:not(pre) > code[class*="language-"],
pre[class*="language-"] {
	background: #272822;
}

/* Inline code */
:not(pre) > code[class*="language-"] {
	padding: .1em;
	border-radius: .3em;
	white-space: normal;
}

.token.comment,
.token.prolog,
.token.doctype,
.token.cdata {
	color: #8292a2;
}

.token.punctuation {
	color: #f8f8f2;
}

.token.namespace {
	opacity: .7;
}

.token.property,
.token.tag,
.token.constant,
.token.symbol,
.token.deleted {
	color: #f92672;
}

.token.boolean,
.token.number {
	color: #ae81ff;
}

.token.selector,
.token.attr-name,
.token.string,
.token.char,
.token.builtin,
.token.inserted {
	color: #a6e22e;
}

.token.operator,
.token.entity,
.token.url,
.language-css .token.string,
.style .token.string,
.token.variable {
	color: #f8f8f2;
}

.token.atrule,
.token.attr-value,
.token.function,
.token.class-name {
	color: #e6db74;
}

.token.keyword {
	color: #66d9ef;
}

.token.regex,
.token.important {
	color: #fd971f;
}

.token.important,
.token.bold {
	font-weight: bold;
}
.token.italic {
	font-style: italic;
}

.token.entity {
	cursor: help;
}
/*
 * New diff- syntax
 */

pre[class*="language-diff-"] {
	--eleventy-code-padding: 1.25em;
	padding-left: var(--eleventy-code-padding);
	padding-right: var(--eleventy-code-padding);
}
.token.deleted {
	background-color: hsl(0, 51%, 37%);
	color: inherit;
}
.token.inserted {
	background-color: hsl(126, 31%, 39%);
	color: inherit;
}

/* Make the + and - characters unselectable for copy/paste */
.token.prefix.unchanged,
.token.prefix.inserted,
.token.prefix.deleted {
	-webkit-user-select: none;
	user-select: none;
	display: inline-flex;
	align-items: center;
	justify-content: center;
	padding-top: 2px;
	padding-bottom: 2px;
}
.token.prefix.inserted,
.token.prefix.deleted {
	width: var(--eleventy-code-padding);
	background-color: rgba(0,0,0,.2);
}

/* Optional: full-width background color */
.token.inserted:not(.prefix),
.token.deleted:not(.prefix) {
	display: block;
	margin-left: calc(-1 * var(--eleventy-code-padding));
	margin-right: calc(-1 * var(--eleventy-code-padding));
	text-decoration: none; /* override del, ins, mark defaults */
	color: inherit; /* override del, ins, mark defaults */
}</style>
		
		<script async="" src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1689302880129363" crossorigin="anonymous"></script>
	</head>
	<!-- Google tag (gtag.js) -->
	<script async="" src="https://www.googletagmanager.com/gtag/js?id=G-HRDC8SXRVG"></script>
	
	<body class="d-flex flex-column h-100">
		<header>
			<nav class="navbar navbar-expand-md navbar-dark fixed-top" style="background-color:rgb(53, 76, 92);">
				<div class="container-fluid">
					<a class="navbar-brand" href="/">RichardN</a>
					<button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation">
						<span class="navbar-toggler-icon"></span>
					</button>
					<div class="collapse navbar-collapse" id="navbarCollapse">
						<ul class="navbar-nav me-auto mb-2 mb-md-0">
							<li class="nav-item">
								<a class="nav-link " href="/">Home</a>
							</li>
							<li class="nav-item">
								<a class="nav-link " href="/about/">About</a>
							</li>
							<li class="nav-item">
								<a class="nav-link " href="/blog/">Blog</a>
							</li>
							<li class="nav-item">
								<a class="nav-link " href="/projects/">Projects</a>
							</li>
							<li class="nav-item">
								<a class="nav-link " href="/series/">Series</a>
							</li>
						</ul>
					</div>
				</div>
        	</nav>
		</header>
		<main class="flex-shrink-0">
			<div class="container main-content">
				


<h1 id="ceiling-fan-remote-hacking">Ceiling Fan Remote Hacking</h1>

<div class="p-1 mb-1 d-flex post-meta">
		<span>
			<i class="bi bi-bookmarks-fill"></i>
				<a href="/tags/cc1101/" class="post-tag">cc1101</a>, 
				<a href="/tags/esp8266/" class="post-tag">esp8266</a>, 
				<a href="/tags/home-assistant/" class="post-tag">home assistant</a>
		</span>
	<div class="p-2 flex-grow-1">&nbsp;</div>
	<span class="post-date">
		<i class="bi bi-calendar-plus-fill"></i>
		<time datetime="2022-06-15">15 June 2022</time>
	</span>
</div>

<p>In this post I will be covering how I modified the &quot;<a href="https://github.com/owenb321/hampton-bay-fan-mqtt">owenb321/hampton-bay-fan-mqtt</a>&quot; to work with some &quot;<strong>Home Decorations #1001 415 438</strong>&quot; fans I had installed a while back. The fans make use of a pretty standard remote control &quot;model number: <strong>TX028C-S</strong>&quot;, however the only repository I found did not produce compatible codes for the fans prompting me to create this offshoot of the repo.</p>
<p>I will cover the basics. I went through reverse engineering the commands sent to \ from the fans along with how I was able to recreate them and send it back to the fans successfully. This was a fun journey where I needed to do a lot of binary maths \ manipulation to get everything working.</p>
<p>You can skip all of this and just get the <strong><a href="https://github.com/rniemand/hampton-bay-fan-mqtt">source code here</a></strong> if you would like.</p>
<h2 id="required-hardware-and-setup">Required Hardware and Setup</h2>
<p>In order to follow along you will need to have access to the following hardware:</p>
<ul>
<li>ESP8266 (or compatible chipset) - I am using a Wemos D1 Mini</li>
<li>CC1101 Wireless Transceiver - I am using <a href="https://www.aliexpress.com/item/1005002848107792.html">this one</a>.</li>
<li>Some wire to make the connections between the <code>ESPxxx</code> and <code>CC1101</code></li>
<li><a href="https://www.arduino.cc/en/software">Arduino IDE</a> - used to build and upload the code</li>
</ul>
<h3 id="module-wiring">Module Wiring</h3>
<p>Depending on your CC1101 module, your wiring may be different, please ensure that you check your modules specific wiring before continuing.</p>
<p>The module that I selected has the following pinout:</p>
<picture><source type="image/avif" srcset="/blog/2022/2022-06-15/post/PPIvB9gtn1-902.avif 902w"><source type="image/webp" srcset="/blog/2022/2022-06-15/post/PPIvB9gtn1-902.webp 902w"><img loading="lazy" decoding="async" src="/blog/2022/2022-06-15/post/PPIvB9gtn1-902.png" alt="" width="902" height="236"></picture>
<p>Corresponding to the physical PCB board layout:</p>
<picture><source type="image/avif" srcset="/blog/2022/2022-06-15/post/Ixt9kyneb--778.avif 778w"><source type="image/webp" srcset="/blog/2022/2022-06-15/post/Ixt9kyneb--778.webp 778w"><img loading="lazy" decoding="async" src="/blog/2022/2022-06-15/post/Ixt9kyneb--778.png" alt="" width="778" height="315"></picture>
<p>Based on the <a href="https://github.com/LSatan/SmartRC-CC1101-Driver-Lib#wiring">wiring diagram here</a> I would need to make the following connections.</p>
<picture><source type="image/avif" srcset="/blog/2022/2022-06-15/post/2tG8lsU2NL-899.avif 899w"><source type="image/webp" srcset="/blog/2022/2022-06-15/post/2tG8lsU2NL-899.webp 899w"><img loading="lazy" decoding="async" src="/blog/2022/2022-06-15/post/2tG8lsU2NL-899.png" alt="" width="899" height="426"></picture>
<table>
<thead>
<tr>
<th>CP1101</th>
<th>ESP8266</th>
<th>Mode</th>
<th>Notes</th>
</tr>
</thead>
<tbody>
<tr>
<td>GD00</td>
<td>D1</td>
<td>Output</td>
<td>Module Info output pin</td>
</tr>
<tr>
<td>GD02</td>
<td>D2</td>
<td>Output</td>
<td>Module information output pin</td>
</tr>
<tr>
<td>SCK</td>
<td>D5</td>
<td>Input</td>
<td>SPI bus clock</td>
</tr>
<tr>
<td>VCC</td>
<td>3V3</td>
<td>-</td>
<td>Power supply must be between <code>1.8-3.6v</code></td>
</tr>
<tr>
<td>MOSI</td>
<td>D7</td>
<td>Input</td>
<td>SPI data input pin</td>
</tr>
<tr>
<td>MISO</td>
<td>D6</td>
<td>Output</td>
<td>SPI data output pin</td>
</tr>
<tr>
<td>CSN</td>
<td>D8</td>
<td>Input</td>
<td>Chip select pin</td>
</tr>
<tr>
<td>GND</td>
<td>GND</td>
<td>-</td>
<td>Ground wire</td>
</tr>
</tbody>
</table>
<h3 id="arduino-libraries">Arduino Libraries</h3>
<p>The following libraries are required to compile the project:</p>
<ul>
<li><a href="https://github.com/LSatan/SmartRC-CC1101-Driver-Lib">SmartRC-CC1101-Driver-Lib</a></li>
<li><a href="https://github.com/sui77/rc-switch">rc-switch</a></li>
<li><a href="https://pubsubclient.knolleary.net/">PubSubClient</a></li>
</ul>
<p>For simplicity and to ensure that your build works these have been included in my repository under the <code>libs</code> directory (<a href="https://github.com/rniemand/hampton-bay-fan-mqtt/tree/main/libs">here</a>).</p>
<h2 id="project-usage">Project Usage</h2>
<p>Usage is pretty straight forward, and can be done by following these steps:</p>
<ul>
<li>Clone the <a href="https://github.com/rniemand/hampton-bay-fan-mqtt">repository</a> locally</li>
<li>Open <code>./homefans/homefans.ino</code></li>
<li>Make any required changes to <code>./homefans/config.h</code>
<ul>
<li><code>WIFI_*</code> to configure the WiFi connection</li>
<li><code>MQTT_*</code> to configure your MQTT connection</li>
<li><code>RF_*</code> to change any required RF related settings</li>
</ul>
</li>
<li>Ensure your device is connected and available via a COM port</li>
<li>Compile and upload the sketch</li>
</ul>
<h2 id="reverse-engineering">Reverse Engineering</h2>
<p>This section covers (at a high-level) how I was able to reverse engineer the remote codes and modify the existing project to meet my needs.</p>
<h3 id="capturing-codes">Capturing Codes</h3>
<p>The first thing I needed to do was to capture any codes being sent by the remotes, this was as simple as modifying the sketch to log out the values captured by RCSwitch:</p>
<pre class="language-cpp" tabindex="0"><code class="language-cpp">value <span class="token operator">=</span> mySwitch<span class="token punctuation">.</span><span class="token function">getReceivedValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
prot <span class="token operator">=</span> mySwitch<span class="token punctuation">.</span><span class="token function">getReceivedProtocol</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
bits <span class="token operator">=</span> mySwitch<span class="token punctuation">.</span><span class="token function">getReceivedBitlength</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<p>Resulting in values like the table below:</p>
<table>
<thead>
<tr>
<th>Protocol</th>
<th>Bits</th>
<th>Value</th>
<th>Dip Pos</th>
<th>Action</th>
</tr>
</thead>
<tbody>
<tr>
<td>11</td>
<td>24</td>
<td>16543350</td>
<td>0001</td>
<td>Fan Speed 1</td>
</tr>
<tr>
<td>11</td>
<td>24</td>
<td>16542838</td>
<td>0011</td>
<td>Fan Speed 1</td>
</tr>
<tr>
<td>11</td>
<td>24</td>
<td>16541814</td>
<td>0111</td>
<td>Fan Speed 1</td>
</tr>
</tbody>
</table>
<h3 id="decoding-the-bits">Decoding the bits</h3>
<p>At first glance this may all seem like nonsense - how does “16543350” turn on a specific fan to a specific speed? To answer that we first need to convert these values to their binary representation, this resulted in the following 24 bits:</p>
<p>| Int | A | B | C | D | E | F |
| 16543350 | 1111 | 1100 | 0110 | 1110 | 0111 | 0110 |
| 16542838 | 1111 | 1100 | 0110 | 1100 | 0111 | 0110 |
| 16542838 | 1111 | 1100 | 0110 | 1000 | 0111 | 0110 |</p>
<blockquote>
<p><strong>Note</strong>: This table is referenced a LOT below
{: .prompt-info }</p>
</blockquote>
<p>This process was repeated for each possible command on the remote and compared once done, during my comparison the following stood out:</p>
<ul>
<li>Columns <code>A</code>, <code>B</code>, and <code>C</code> are static regardless of the <code>DIP switch</code> positions
<ul>
<li>Perhaps this is a carrier code \ id \ etc</li>
</ul>
</li>
<li>Column <code>D</code> is the positions of the <code>DIP switches</code> (only inverted - 0001 -&gt; 1110)</li>
<li>Column <code>E</code> is generally <code>0111</code> unless using light effect commands, in that case it is <code>0110</code></li>
<li>Column <code>F</code> is the actual command to execute (i.e. fan speed, light on, etc.)</li>
</ul>
<p>With this information I was able to piece together the following truth table:</p>
<picture><source type="image/avif" srcset="/blog/2022/2022-06-15/post/fA853PW74Q-405.avif 405w"><source type="image/webp" srcset="/blog/2022/2022-06-15/post/fA853PW74Q-405.webp 405w"><img loading="lazy" decoding="async" src="/blog/2022/2022-06-15/post/fA853PW74Q-405.png" alt="" width="405" height="218"></picture>
<h3 id="encoding-codes">Encoding Codes</h3>
<p>The process of re-encoding the remote codes is as simple as reversing this process (covered later on), at least this is some good news - we can work with this.</p>
<h2 id="arduino-sketch">Arduino Sketch</h2>
<p>Implementing this in the original Arduino sketch was a bit of a hack on my end, however with some persistence I was able to do it.</p>
<h3 id="decoding-rf-input">Decoding RF Input</h3>
<p>When a RF code is detected we need to decode it, this process begins with reading the received value:</p>
<pre class="language-cpp" tabindex="0"><code class="language-cpp">value <span class="token operator">=</span> mySwitch<span class="token punctuation">.</span><span class="token function">getReceivedValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<p>Followed by manipulating the value into somethin we can work with:</p>
<pre class="language-cpp" tabindex="0"><code class="language-cpp"><span class="token keyword">int</span> subtractedValue <span class="token operator">=</span> value <span class="token operator">-</span> <span class="token number">0b111111000110000000000000</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> truncatedValue  <span class="token operator">=</span> subtractedValue <span class="token operator">>></span> <span class="token number">8</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> id              <span class="token operator">=</span> truncatedValue <span class="token operator">^</span><span class="token number">0b1111</span><span class="token punctuation">;</span></code></pre>
<ul>
<li>First we can remove the common <code>1111 1100 0110</code> using a subtraction</li>
<li>We can bit-shift right by 8 places to remove the mode (column <code>E</code>) and command (column <code>F</code>) to be left with the inverted DIP switch values</li>
<li>We can then invert the bits using an XOR command to get the actual DIP switch positions</li>
</ul>
<p>Once done we need to check that the RF protocol and bits are what we are expecting before we can continue.</p>
<pre class="language-cpp" tabindex="0"><code class="language-cpp"><span class="token keyword">if</span><span class="token punctuation">(</span> prot <span class="token operator">==</span> <span class="token number">11</span> <span class="token operator">&amp;&amp;</span> bits <span class="token operator">==</span> <span class="token number">24</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span></code></pre>
<p>Once confirmed we can start unpacking the Mode from the received value using the subtraction result.</p>
<pre class="language-cpp" tabindex="0"><code class="language-cpp"><span class="token keyword">int</span> cmdMode <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>subtractedValue <span class="token operator">&amp;</span> <span class="token number">0b000011110000</span><span class="token punctuation">)</span> <span class="token operator">>></span> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token number">6</span><span class="token punctuation">;</span></code></pre>
<ul>
<li>I decided to use an AND operation to zero out all useless bits - effectively performing a soft-truncation of the left most bits</li>
<li>We binary-shift right 4 bits to get the command as the left most bits are now <code>0000</code></li>
<li>This results in either an int value of 6 or 7</li>
<li>Using modulus we can convert that to a 1 or 0
<ul>
<li><code>1</code> = normal commands</li>
<li><code>0</code> = light temperature related commands</li>
</ul>
</li>
</ul>
<p>We can finally turn our attention to extracting the actual command from the received code, this is done like so:</p>
<pre class="language-cpp" tabindex="0"><code class="language-cpp"><span class="token keyword">int</span> command <span class="token operator">=</span> subtractedValue <span class="token operator">&amp;</span> <span class="token number">0b000000001111</span><span class="token punctuation">;</span></code></pre>
<ul>
<li>Using an AND operation we can zero out columns <code>D</code> and <code>E</code></li>
<li>The remaining value is the command to execute
<ul>
<li>You can see an example of commands in the reverse engineering section above</li>
</ul>
</li>
</ul>
<p>All that is left to do is respond to the received code.</p>
<h3 id="encoding-codes-2">Encoding Codes</h3>
<p>Encoding outgoing RF codes is basically reversing the process used to decode them, and looks like this:</p>
<pre class="language-cpp" tabindex="0"><code class="language-cpp"><span class="token keyword">int</span> baseCommand <span class="token operator">=</span> <span class="token number">0b111111000110000000000000</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> fanIdDips   <span class="token operator">=</span> <span class="token punctuation">(</span>fanId <span class="token operator">^</span> <span class="token number">0b1111</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token number">8</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> commandInt  <span class="token operator">=</span> <span class="token number">0b01110000</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> command     <span class="token operator">=</span> <span class="token number">0b0000</span><span class="token punctuation">;</span></code></pre>
<ul>
<li>Start with defining the static parts of the remote code (columns <code>A</code>, <code>B</code>, and <code>C</code>)
<ul>
<li>i.e. <code>0b111111000110000000000000</code></li>
</ul>
</li>
<li>Invert the fanID to recreate (column <code>D</code>)
<ul>
<li>Bit shift this left by 8 to allow for insertion of column <code>E</code>, and <code>F</code></li>
</ul>
</li>
<li>Define the static commandInt value
<ul>
<li>In the future this would change if I add support for the light mode</li>
</ul>
</li>
<li>Finally I define a placeholder commandInt to populate with the outgoing command</li>
</ul>
<p>Next I switch based on the received MQTT attribute (<code>attr</code>) and command (<code>payload</code>).</p>
<p>Once set, the final command is generated by combining all the parts (basically adding the int values together) to create the expected int of <code>16543350</code>.</p>
<pre class="language-cpp" tabindex="0"><code class="language-cpp"><span class="token keyword">int</span> finalCommand <span class="token operator">=</span> baseCommand <span class="token operator">+</span> fanIdDips <span class="token operator">+</span> commandInt <span class="token operator">+</span> command<span class="token punctuation">;</span></code></pre>
<p>This value is then transmitted using the same protocol and bit length used to receive it, this results in the fan thinking the command came from the remote.</p>
<blockquote>
<p>If your fans do not respond to the command you should try changing the frequency value <code>RF_FREQUENCY</code> - I wasted a good 45 min with this one!
{: .prompt-tip }</p>
</blockquote>
<h3 id="everything-else">Everything Else</h3>
<p>The rest of the code is pretty much in line with the source repository.</p>
<p>I have no doubtably introduced some new BUGS in the code-base and will need to tackle them when discovered!</p>
<h2 id="home-assistant">Home Assistant</h2>
<p>Once you have your ESP device deployed, adding it to Home Assistant is as simple as adding an MQTT fan and light entry per fan you wish to control.</p>
<h3 id="mqtt-fan-configuration">MQTT Fan Configuration</h3>
<p>In this case I am creating an entry for my remote with a DIP switch position of <code>0001</code>:</p>
<pre class="language-yaml" tabindex="0"><code class="language-yaml"><span class="token key atrule">mqtt</span><span class="token punctuation">:</span>
  <span class="token key atrule">fan</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> <span class="token string">"Master Bedroom Fan"</span>
      <span class="token key atrule">state_topic</span><span class="token punctuation">:</span> <span class="token string">"home/fans/0001/on/state"</span>
      <span class="token key atrule">command_topic</span><span class="token punctuation">:</span> <span class="token string">"home/fans/0001/on/set"</span>
      <span class="token key atrule">preset_mode_state_topic</span><span class="token punctuation">:</span> <span class="token string">"home/fans/0001/speed/state"</span>
      <span class="token key atrule">preset_mode_command_topic</span><span class="token punctuation">:</span> <span class="token string">"home/fans/0001/speed/set"</span>
      <span class="token key atrule">preset_modes</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token string">"off"</span>
        <span class="token punctuation">-</span> <span class="token string">"low"</span>
        <span class="token punctuation">-</span> <span class="token string">"medium"</span>
        <span class="token punctuation">-</span> <span class="token string">"high"</span>
      <span class="token key atrule">qos</span><span class="token punctuation">:</span> <span class="token number">0</span>
      <span class="token key atrule">payload_on</span><span class="token punctuation">:</span> <span class="token string">"on"</span>
      <span class="token key atrule">payload_off</span><span class="token punctuation">:</span> <span class="token string">"off"</span></code></pre>
<h3 id="mqtt-light-configuration">MQTT Light Configuration</h3>
<p>In this case I am creating an entry for my remote with a DIP switch position of <code>0001</code>:</p>
<pre class="language-yaml" tabindex="0"><code class="language-yaml"><span class="token key atrule">mqtt</span><span class="token punctuation">:</span>
  <span class="token key atrule">light</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> <span class="token string">"Master Bedroom Fan Light"</span>
      <span class="token key atrule">state_topic</span><span class="token punctuation">:</span> <span class="token string">"home/fans/0001/light/state"</span>
      <span class="token key atrule">command_topic</span><span class="token punctuation">:</span> <span class="token string">"home/fans/0001/light/set"</span>
      <span class="token key atrule">qos</span><span class="token punctuation">:</span> <span class="token number">0</span>
      <span class="token key atrule">payload_on</span><span class="token punctuation">:</span> <span class="token string">"on"</span>
      <span class="token key atrule">payload_off</span><span class="token punctuation">:</span> <span class="token string">"off"</span>
      <span class="token key atrule">optimistic</span><span class="token punctuation">:</span> <span class="token boolean important">false</span></code></pre>
<h3 id="entities">Entities</h3>
<p>Once restarted you should see all your fan and light entities in Home Assistant.</p>
<picture><source type="image/avif" srcset="/blog/2022/2022-06-15/post/Jf6O2ohJ8t-679.avif 679w"><source type="image/webp" srcset="/blog/2022/2022-06-15/post/Jf6O2ohJ8t-679.webp 679w"><img loading="lazy" decoding="async" src="/blog/2022/2022-06-15/post/Jf6O2ohJ8t-679.png" alt="" width="679" height="307"></picture>
<p>As expected the light entries work as per normal:</p>
<picture><source type="image/avif" srcset="/blog/2022/2022-06-15/post/OOQDZM3WWs-378.avif 378w"><source type="image/webp" srcset="/blog/2022/2022-06-15/post/OOQDZM3WWs-378.webp 378w"><img loading="lazy" decoding="async" src="/blog/2022/2022-06-15/post/OOQDZM3WWs-378.png" alt="" width="378" height="178"></picture>
<p>Along with the fan entities:</p>
<picture><source type="image/avif" srcset="/blog/2022/2022-06-15/post/3PQeOu4SIZ-387.avif 387w"><source type="image/webp" srcset="/blog/2022/2022-06-15/post/3PQeOu4SIZ-387.webp 387w"><img loading="lazy" decoding="async" src="/blog/2022/2022-06-15/post/3PQeOu4SIZ-387.png" alt="" width="387" height="247"></picture>
<h3 id="dashboard-configuration">Dashboard Configuration</h3>
<p>I am personally using the following configuration to control my fans in Home Assistant:</p>
<picture><source type="image/avif" srcset="/blog/2022/2022-06-15/post/5cN81qL02m-509.avif 509w"><source type="image/webp" srcset="/blog/2022/2022-06-15/post/5cN81qL02m-509.webp 509w"><img loading="lazy" decoding="async" src="/blog/2022/2022-06-15/post/5cN81qL02m-509.png" alt="" width="509" height="151"></picture>
<p>Backed by the following configuration:</p>
<pre class="language-yaml" tabindex="0"><code class="language-yaml"><span class="token key atrule">square</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
<span class="token key atrule">columns</span><span class="token punctuation">:</span> <span class="token number">5</span>
<span class="token key atrule">title</span><span class="token punctuation">:</span> Master Bedroom Fan
<span class="token key atrule">type</span><span class="token punctuation">:</span> grid
<span class="token key atrule">cards</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">show_name</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
    <span class="token key atrule">show_icon</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token key atrule">type</span><span class="token punctuation">:</span> button
    <span class="token key atrule">tap_action</span><span class="token punctuation">:</span>
      <span class="token key atrule">action</span><span class="token punctuation">:</span> call<span class="token punctuation">-</span>service
      <span class="token key atrule">service</span><span class="token punctuation">:</span> fan.toggle
      <span class="token key atrule">data</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
      <span class="token key atrule">target</span><span class="token punctuation">:</span>
        <span class="token key atrule">entity_id</span><span class="token punctuation">:</span> fan.master_bedroom_fan
    <span class="token key atrule">entity</span><span class="token punctuation">:</span> switch.master_bedroom
    <span class="token key atrule">icon</span><span class="token punctuation">:</span> mdi<span class="token punctuation">:</span>ceiling<span class="token punctuation">-</span>fan
    <span class="token key atrule">show_state</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token key atrule">hold_action</span><span class="token punctuation">:</span>
      <span class="token key atrule">action</span><span class="token punctuation">:</span> none
  <span class="token punctuation">-</span> <span class="token key atrule">show_name</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
    <span class="token key atrule">show_icon</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token key atrule">type</span><span class="token punctuation">:</span> button
    <span class="token key atrule">tap_action</span><span class="token punctuation">:</span>
      <span class="token key atrule">action</span><span class="token punctuation">:</span> call<span class="token punctuation">-</span>service
      <span class="token key atrule">service</span><span class="token punctuation">:</span> light.toggle
      <span class="token key atrule">data</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
      <span class="token key atrule">target</span><span class="token punctuation">:</span>
        <span class="token key atrule">entity_id</span><span class="token punctuation">:</span> light.master_bedroom_fan_light
    <span class="token key atrule">entity</span><span class="token punctuation">:</span> light.master_bedroom_fan_light
    <span class="token key atrule">icon</span><span class="token punctuation">:</span> mdi<span class="token punctuation">:</span>ceiling<span class="token punctuation">-</span>fan<span class="token punctuation">-</span>light
    <span class="token key atrule">hold_action</span><span class="token punctuation">:</span>
      <span class="token key atrule">action</span><span class="token punctuation">:</span> none
    <span class="token key atrule">show_state</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
  <span class="token punctuation">-</span> <span class="token key atrule">show_name</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token key atrule">show_icon</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token key atrule">type</span><span class="token punctuation">:</span> button
    <span class="token key atrule">tap_action</span><span class="token punctuation">:</span>
      <span class="token key atrule">action</span><span class="token punctuation">:</span> call<span class="token punctuation">-</span>service
      <span class="token key atrule">service</span><span class="token punctuation">:</span> fan.set_preset_mode
      <span class="token key atrule">data</span><span class="token punctuation">:</span>
        <span class="token key atrule">preset_mode</span><span class="token punctuation">:</span> low
      <span class="token key atrule">target</span><span class="token punctuation">:</span>
        <span class="token key atrule">entity_id</span><span class="token punctuation">:</span> fan.master_bedroom_fan
    <span class="token key atrule">entity</span><span class="token punctuation">:</span> <span class="token string">''</span>
    <span class="token key atrule">icon</span><span class="token punctuation">:</span> mdi<span class="token punctuation">:</span>fan<span class="token punctuation">-</span>speed<span class="token punctuation">-</span><span class="token number">1</span>
    <span class="token key atrule">hold_action</span><span class="token punctuation">:</span>
      <span class="token key atrule">action</span><span class="token punctuation">:</span> none
  <span class="token punctuation">-</span> <span class="token key atrule">show_name</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token key atrule">show_icon</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token key atrule">type</span><span class="token punctuation">:</span> button
    <span class="token key atrule">tap_action</span><span class="token punctuation">:</span>
      <span class="token key atrule">action</span><span class="token punctuation">:</span> call<span class="token punctuation">-</span>service
      <span class="token key atrule">service</span><span class="token punctuation">:</span> fan.set_preset_mode
      <span class="token key atrule">data</span><span class="token punctuation">:</span>
        <span class="token key atrule">preset_mode</span><span class="token punctuation">:</span> medium
      <span class="token key atrule">target</span><span class="token punctuation">:</span>
        <span class="token key atrule">entity_id</span><span class="token punctuation">:</span> fan.master_bedroom_fan
    <span class="token key atrule">entity</span><span class="token punctuation">:</span> <span class="token string">''</span>
    <span class="token key atrule">icon</span><span class="token punctuation">:</span> mdi<span class="token punctuation">:</span>fan<span class="token punctuation">-</span>speed<span class="token punctuation">-</span><span class="token number">2</span>
    <span class="token key atrule">hold_action</span><span class="token punctuation">:</span>
      <span class="token key atrule">action</span><span class="token punctuation">:</span> none
  <span class="token punctuation">-</span> <span class="token key atrule">show_name</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token key atrule">show_icon</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token key atrule">type</span><span class="token punctuation">:</span> button
    <span class="token key atrule">tap_action</span><span class="token punctuation">:</span>
      <span class="token key atrule">action</span><span class="token punctuation">:</span> call<span class="token punctuation">-</span>service
      <span class="token key atrule">service</span><span class="token punctuation">:</span> fan.set_preset_mode
      <span class="token key atrule">data</span><span class="token punctuation">:</span>
        <span class="token key atrule">preset_mode</span><span class="token punctuation">:</span> high
      <span class="token key atrule">target</span><span class="token punctuation">:</span>
        <span class="token key atrule">entity_id</span><span class="token punctuation">:</span> fan.master_bedroom_fan
    <span class="token key atrule">entity</span><span class="token punctuation">:</span> <span class="token string">''</span>
    <span class="token key atrule">icon</span><span class="token punctuation">:</span> mdi<span class="token punctuation">:</span>fan<span class="token punctuation">-</span>speed<span class="token punctuation">-</span><span class="token number">3</span>
    <span class="token key atrule">hold_action</span><span class="token punctuation">:</span>
      <span class="token key atrule">action</span><span class="token punctuation">:</span> none</code></pre>
<p>This can be repeated for each fan you wish to control.</p>
<h2 id="proto-boarding">Proto-boarding</h2>
<p>Finally I tried to neaten everything up by placing all the components on a proto-board, and I will soon be designing and printing a case for the final project.</p>
<picture><source type="image/avif" srcset="/blog/2022/2022-06-15/post/egmWFa_ZKX-719.avif 719w"><source type="image/webp" srcset="/blog/2022/2022-06-15/post/egmWFa_ZKX-719.webp 719w"><img loading="lazy" decoding="async" src="/blog/2022/2022-06-15/post/egmWFa_ZKX-719.png" alt="" width="719" height="807"></picture>
_Looking good from the front_
<picture><source type="image/avif" srcset="/blog/2022/2022-06-15/post/qthnhDj1wI-896.avif 896w"><source type="image/webp" srcset="/blog/2022/2022-06-15/post/qthnhDj1wI-896.webp 896w"><img loading="lazy" decoding="async" src="/blog/2022/2022-06-15/post/qthnhDj1wI-896.png" alt="" width="896" height="727"></picture>
_The wiring at the back is not amazing_
<picture><source type="image/avif" srcset="/blog/2022/2022-06-15/post/jjqo4BwVc1-880.avif 880w"><source type="image/webp" srcset="/blog/2022/2022-06-15/post/jjqo4BwVc1-880.webp 880w"><img loading="lazy" decoding="async" src="/blog/2022/2022-06-15/post/jjqo4BwVc1-880.png" alt="" width="880" height="562"></picture>
_don't forget the hot glue_
<h2 id="in-closing">In Closing</h2>
<p>This project was a good brain teaser and forced me to re-learn basic comp-sci principles like bitwise operations and binary maths.</p>
<p>I would like to give a shout out to <strong><a href="https://github.com/owenb321">Ben Owen</a></strong> for the original work done here as it saved me a lot of time along with providing me with a good starting place.</p>
<p>Please feel free to <a href="https://github.com/rniemand/hampton-bay-fan-mqtt">clone my repo</a>, make changes, submit pull requests as this is no way complete - yet!</p>
<p>Happy hacking.</p>

<div class="d-flex mb-3 prev-next">
	<i class="bi bi-arrow-left-short"></i>
	<span class="text-start">Previous<br><a href="/blog/2022/2022-06-10/post/">HASS On Unraid: Times of Day Automations</a></span>
	
	<div class="p-2 flex-grow-1">&nbsp;</div>
	<span class="text-end">Next<br><a href="/blog/2022/2022-07-18/post/">Legacy Blog Posts (2011)</a></span>
	<i class="bi bi-arrow-right-short"></i>
	
</div>



			</div>
		</main>
		<footer class="footer mt-auto py-3 bg-body-tertiary">
			<div class="container text-end">
				<span class="text-body-secondary">
					<a href="https://github.com/rniemand" target="_blank">GitHub</a>
				</span>
			</div>
		</footer>
		<!-- This page `/blog/2022/2022-06-15/post/` was built on 2025-07-07T22:37:44.946Z -->
		<script type="module" src="/dist/uHLRy2-o6f.js"></script>
		<script src="//cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/js/bootstrap.bundle.min.js"></script>
	</body>
</html>
